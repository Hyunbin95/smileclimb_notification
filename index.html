<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smile Climbing â€“ ì›”ê°„ ì •ëª¨ ìŠ¤ì¼€ì¤„</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;900&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0ece6;
      padding: 24px 16px 60px;
      min-height: 100vh;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì„¤ì • íŒ¨ë„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .settings-wrap {
      max-width: 680px;
      margin: 0 auto 20px;
    }
    .settings-toggle {
      width: 100%;
      background: #1a1a1a;
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 13px 20px;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Noto Sans KR', sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      letter-spacing: 0.3px;
    }
    .settings-toggle .arrow { transition: transform .25s; font-size: 16px; }
    .settings-toggle.open .arrow { transform: rotate(180deg); }

    .settings-panel {
      background: #fff;
      border-radius: 0 0 16px 16px;
      padding: 20px 22px 22px;
      display: none;
      flex-direction: column;
      gap: 18px;
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    .settings-panel.open { display: flex; }

    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .form-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 120px; }
    .form-group label {
      font-size: 11.5px;
      font-weight: 700;
      color: #555;
      letter-spacing: 0.3px;
    }
    .form-group input, .form-group select {
      border: 1.5px solid #ddd;
      border-radius: 9px;
      padding: 8px 11px;
      font-size: 13px;
      font-family: 'Noto Sans KR', sans-serif;
      color: #222;
      outline: none;
      transition: border-color .2s;
      background: #fafafa;
    }
    .form-group input:focus, .form-group select:focus { border-color: #7BC67E; background: #fff; }

    .section-divider {
      font-size: 12px;
      font-weight: 700;
      color: #888;
      border-bottom: 1.5px solid #f0ece6;
      padding-bottom: 6px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .section-divider span { margin-right: 6px; }

    /* íŠ¹ë³„ ì¼ì • í–‰ */
    .special-list { display: flex; flex-direction: column; gap: 8px; }
    .special-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .special-row input { flex: 1; }
    .special-row input.date-input { max-width: 80px; }
    .btn-remove {
      background: #ffe0e0;
      color: #e25555;
      border: none;
      border-radius: 8px;
      width: 30px; height: 30px;
      font-size: 16px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .btn-add {
      background: #edf7ee;
      color: #4caf50;
      border: none;
      border-radius: 9px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 700;
      font-family: 'Noto Sans KR', sans-serif;
      cursor: pointer;
      align-self: flex-start;
    }

    .btn-generate {
      background: linear-gradient(135deg, #7BC67E, #4caf50);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 13px;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Noto Sans KR', sans-serif;
      cursor: pointer;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 12px rgba(123,198,126,.4);
    }

    /* ê³µì§€ ëª¨ë“œ ë²„íŠ¼ */
    .top-actions {
      max-width: 680px;
      margin: 0 auto 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .btn-notice-mode {
      background: #F4A261;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 9px 16px;
      font-size: 12px;
      font-weight: 700;
      font-family: 'Noto Sans KR', sans-serif;
      cursor: pointer;
    }
    .btn-notice-mode:hover { background: #e8904a; }

    /* ê³µì§€ ëª¨ë“œì¼ ë•Œ ì„¤ì • ìˆ¨ê¹€ */
    body.notice-mode .settings-wrap,
    body.notice-mode .top-actions { display: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë‹¬ë ¥ ì¹´ë“œ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card {
      background: #fff;
      border-radius: 28px;
      width: 100%;
      max-width: 680px;
      margin: 0 auto;
      box-shadow: 0 8px 40px rgba(0,0,0,.12);
      overflow: hidden;
    }

    /* âœ… ìŠ¤í¬ë¡¤ ì œê±° ìœ ì§€ */
    .calendar-scroll { overflow-x: hidden; padding-bottom: 0; }
    .calendar-wide { min-width: 0; }

    /* Header */
    .header {
      position: relative;
      background: #1a1a1a;
      padding: 26px 30px 20px;
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .header img {
      width: 84px; height: 84px;
      object-fit: contain;
      filter: brightness(0) invert(1);
    }
    .header-text .month-label { font-size: 12px; font-weight: 600; color: #999; letter-spacing: 3px; }
    .header-text h1 { font-size: 30px; font-weight: 900; color: #fff; line-height: 1.15; }
    .header-text h1 span { color: #7BC67E; }
    .header-text .subtitle { margin-top: 3px; font-size: 12px; color: #bbb; }

    /* Legend */
    .legend {
      display: flex; gap: 12px; flex-wrap: wrap;
      padding: 12px 28px;
      background: #f9f6f2;
      border-bottom: 1px solid #eee;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11.5px; font-weight: 600; color: #444; }
    .dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }

    /* Calendar */
    .calendar-section { padding: 14px 14px 14px; }
    .day-headers { display: grid; grid-template-columns: repeat(7,1fr); text-align: center; margin-bottom: 6px; }
    .day-headers div { font-size: 12px; font-weight: 700; padding: 4px 0; color: #888; }
    .day-headers .sun { color: #e25555; }
    .day-headers .sat { color: #4a90d9; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }

    .cell {
      border-radius: 11px;
      padding: 5px 4px 6px;
      min-height: 62px;
      display: flex; flex-direction: column; align-items: center;
      background: #fafafa;
      border: 1.5px solid #f0ece7;
    }
    .cell.empty { background: transparent; border-color: transparent; }
    .cell.today { border-color: #F4A261; background: #fff8f2; }

    .date-num { font-size: 13px; font-weight: 700; color: #222; margin-bottom: 3px; line-height: 1; }
    .cell.sun .date-num { color: #e25555; }
    .cell.sat .date-num { color: #4a90d9; }

    .badge {
      font-size: 10px; font-weight: 700;
      border-radius: 12px;
      padding: 2px 6px;
      margin-top: 3px;
      text-align: center;
      max-width: 100%;
      white-space: normal;
      word-break: keep-all;
      overflow-wrap: anywhere;
      line-height: 1.15;
    }

    .badge.weekend{
      width: 90%;
      height: 7px;
      padding: 0;
      border-radius: 6px;
      font-size: 0;
      margin-top: 4px;
    }
    .badge.weekday {
      width: 90%;
      height: 7px;
      padding: 0;
      border-radius: 6px;
      font-size: 0;
      margin-top: 4px;
    }

    .badge.weekend { background: #7BC67E; color: #fff; }
    .badge.weekday { background: #F4A261; color: #fff; }
    .badge.special { background: #3a3d3b; color: #fff; }

    /* Info Cards */
    .info-section { padding: 0 20px 24px; display: flex; flex-direction: column; gap: 10px; }
    .info-card {
      border-radius: 14px; padding: 13px 16px;
      display: flex; align-items: flex-start; gap: 11px;
    }
    .info-card.green  { background: #edf7ee; border-left: 4px solid #7BC67E; }
    .info-card.orange { background: #fff5ec; border-left: 4px solid #F4A261; }
    .info-card.purple { background: #fdf0f8; border-left: 4px solid #7BC67E; }
    .info-card.blue   { background: #eef4ff; border-left: 4px solid #6699ee; }
    .info-card .icon { font-size: 20px; line-height: 1; }
    .info-card .body strong { font-size: 12.5px; font-weight: 700; color: #222; display: block; margin-bottom: 2px; }
    .info-card .body span   { font-size: 11.5px; color: #666; line-height: 1.6; display: block; }

    /* Footer */
    .footer { background: #1a1a1a; padding: 14px 28px; text-align: center; color: #777; font-size: 11.5px; }
    .footer strong { color: #aaa; }

    /* ê³µì§€ ëª¨ë“œ ë³µê·€ ë²„íŠ¼ (ë‹¬ë ¥ ìœ„) */
    .notice-exit {
      display: none;
      max-width: 680px;
      margin: 0 auto 14px;
      text-align: right;
    }
    body.notice-mode .notice-exit { display: block; }
    .notice-exit button {
      background: #555; color: #fff; border: none; border-radius: 9px;
      padding: 8px 16px; font-size: 12px; font-weight: 700;
      font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    }

    @media (max-width: 520px) {
      body { padding: 18px 10px 50px; }
      .header { padding: 20px 18px 16px; gap: 12px; }
      .header img { width: 64px; height: 64px; }
      .header-text h1 { font-size: 24px; }
      .legend { padding: 10px 16px; gap: 10px; }

      .calendar-section { padding: 12px 10px 12px; }
      .day-headers div { font-size: 11px; padding: 3px 0; }
      .calendar-grid { gap: 3px; }

      .cell { min-height: 56px; padding: 4px 2px 5px; border-radius: 10px; }
      .date-num { font-size: 12px; margin-bottom: 2px; }

      .badge { font-size: 8px; padding: 2px 4px; margin-top: 2px; }

      .info-section { padding: 0 12px 18px; }
      .footer { padding: 12px 14px; font-size: 11px; }
    }

    @media print { .settings-wrap, .top-actions, .notice-exit { display: none !important; } }
  </style>
</head>
<body>

  <!-- âœ… ìš´ì˜ì§„ ì „ìš© ê´€ë¦¬ì ë°” -->
  <div id="adminBar" style="display:none; max-width:680px; margin:0 auto 10px; gap:8px; justify-content:flex-end;">
    <button onclick="openIdentity()" style="background:#222;color:#fff;border:none;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer;">
      ğŸ” ìš´ì˜ì§„ ë¡œê·¸ì¸/ê³„ì •
    </button>
    <button id="btnPreview" onclick="adminPreview()" style="display:none;background:#7BC67E;color:#fff;border:none;border-radius:10px;padding:9px 14px;font-weight:800;cursor:pointer;">
      ğŸ‘€ ë¯¸ë¦¬ë³´ê¸°
    </button>
    <button id="btnApply" onclick="adminApply()" style="display:none;background:#F4A261;color:#fff;border:none;border-radius:10px;padding:9px 14px;font-weight:800;cursor:pointer;">
      âœ… ì ìš©(ì»¤ë°‹)
    </button>
  </div>

  <!-- ê³µì§€ ëª¨ë“œ ë³µê·€ -->
  <div class="notice-exit" style="display:none;">
    <button onclick="exitNoticeMode()">âš™ï¸ ì„¤ì •ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>

  <!-- ìƒë‹¨ ë²„íŠ¼ -->
  <div class="top-actions">
    <button class="btn-notice-mode" onclick="enterNoticeMode()">ğŸ“¢ ê³µì§€ ìº¡ì²˜ ëª¨ë“œ</button>
  </div>

  <!-- â”€â”€ ì„¤ì • íŒ¨ë„ â”€â”€ -->
  <div class="settings-wrap" style="display:none;">
    <button class="settings-toggle open" id="toggleBtn" onclick="toggleSettings()">
      <span>âš™ï¸ ì •ëª¨ ì¼ì • ì„¤ì •í•˜ê¸°</span>
      <span class="arrow">â–²</span>
    </button>
    <div class="settings-panel open" id="settingsPanel">

      <!-- ì—°ì›” -->
      <div class="section-divider"><span>ğŸ“…</span>ë‹¬ë ¥ ì—°ì›”</div>
      <div class="form-row">
        <div class="form-group">
          <label>ì—°ë„</label>
          <input type="number" id="inp-year" value="2026" min="2020" max="2040"/>
        </div>
        <div class="form-group">
          <label>ì›”</label>
          <select id="inp-month">
            <option value="1">1ì›”</option><option value="2">2ì›”</option>
            <option value="3" selected>3ì›”</option><option value="4">4ì›”</option>
            <option value="5">5ì›”</option><option value="6">6ì›”</option>
            <option value="7">7ì›”</option><option value="8">8ì›”</option>
            <option value="9">9ì›”</option><option value="10">10ì›”</option>
            <option value="11">11ì›”</option><option value="12">12ì›”</option>
          </select>
        </div>
      </div>

      <!-- ì£¼ë§ ì •ëª¨ -->
      <div class="section-divider"><span>ğŸŸ¢</span>ì£¼ë§ ì •ëª¨</div>
      <div class="form-row">
        <div class="form-group" style="min-width:200px">
          <label>ë‚ ì§œ (ì‰¼í‘œë¡œ êµ¬ë¶„ ì˜ˆ: 1, 8, 15, 22)</label>
          <input type="text" id="inp-weekend-dates" placeholder="ì˜ˆ: 1, 8, 15, 22"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ì§‘í•© ì‹œê°„</label>
          <input type="text" id="inp-weekend-time" placeholder="ì˜ˆ: ì˜¤ì „ 10:00"/>
        </div>
        <div class="form-group">
          <label>ì¥ì†Œ</label>
          <input type="text" id="inp-weekend-place" placeholder="ì˜ˆ: ë”í´ë¼ì„ ê°•ë‚¨ì "/>
        </div>
      </div>

      <!-- í‰ì¼ ì •ëª¨ -->
      <div class="section-divider"><span>ğŸŸ </span>í‰ì¼ ì •ëª¨</div>
      <div class="form-row">
        <div class="form-group" style="min-width:200px">
          <label>ë‚ ì§œ (ì‰¼í‘œë¡œ êµ¬ë¶„ ì˜ˆ: 4, 11, 18, 25)</label>
          <input type="text" id="inp-weekday-dates" placeholder="ì˜ˆ: 4, 11, 18, 25"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ì§‘í•© ì‹œê°„</label>
          <input type="text" id="inp-weekday-time" placeholder="ì˜ˆ: ì €ë… 7:30"/>
        </div>
        <div class="form-group">
          <label>ì¥ì†Œ</label>
          <input type="text" id="inp-weekday-place" placeholder="ì˜ˆ: ë”í´ë¼ì„ ì‹ ë¦¼ì "/>
        </div>
      </div>

      <!-- íŠ¹ë³„ ì¼ì • -->
      <div class="section-divider"><span>â­</span>ì •ëª¨ìƒì„±</div>
      <div class="special-list" id="specialList">
        <div class="special-row">
          <input class="date-input" type="number" placeholder="ë‚ ì§œ" min="1" max="31" style="border:1.5px solid #ddd;border-radius:9px;padding:8px 11px;font-size:13px;font-family:inherit;outline:none;background:#fafafa;"/>
          <input type="text" placeholder="ë‚´ìš© (ì˜ˆ: ë²ˆê°œ, ëŒ€íšŒ ì°¸ê°€)" style="border:1.5px solid #ddd;border-radius:9px;padding:8px 11px;font-size:13px;font-family:inherit;outline:none;flex:1;background:#fafafa;"/>
          <input type="text" placeholder="ì¥ì†Œ (ì„ íƒ)" style="border:1.5px solid #ddd;border-radius:9px;padding:8px 11px;font-size:13px;font-family:inherit;outline:none;flex:1;background:#fafafa;"/>
          <button class="btn-remove" onclick="removeSpecial(this)">Ã—</button>
        </div>
      </div>
      <button class="btn-add" onclick="addSpecial()">+ íŠ¹ë³„ ì¼ì • ì¶”ê°€</button>

      <!-- ê³µì§€ í•˜ë‹¨ ë¬¸êµ¬ -->
      <div class="section-divider"><span>ğŸ’¬</span>ê³µì§€ í•˜ë‹¨ ë¬¸êµ¬</div>
      <div class="form-row">
        <div class="form-group">
          <label>ì—°ë½ì²˜ / ì±„ë„</label>
          <input type="text" id="inp-contact" placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ…" value="ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ…"/>
        </div>
        <div class="form-group">
          <label>í•´ì‹œíƒœê·¸</label>
          <input type="text" id="inp-hashtag" placeholder="ì˜ˆ: #ì‹±ê¸€ë²™í´" value="#ì‹±ê¸€ë²™í´"/>
        </div>
      </div>

      <button class="btn-generate" onclick="generate()">ğŸ—“ï¸ ë‹¬ë ¥ ìƒì„±í•˜ê¸°</button>
    </div>
  </div>

  <!-- â”€â”€ ë‹¬ë ¥ ì¹´ë“œ â”€â”€ -->
  <div class="card" id="calendarCard">

    <div class="header">
      <img src="https://www.genspark.ai/api/files/s/mjL4aDIJ" alt="Smile Climbing Logo" onerror="this.style.display='none'"/>
      <div class="header-text">
        <div class="month-label" id="hdr-label">2026 Schedule</div>
        <h1 id="hdr-title">3ì›” <span>ì •ëª¨ ì¼ì •</span></h1>
        <div class="subtitle">Smile Climbing Crew ğŸ§—</div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="dot" style="background:#0d1a0e"></div> ì •ëª¨</div>
      <div class="legend-item"><div class="dot" style="background:#F4A261"></div> í‰ì¼ì •ëª¨</div>
      <div class="legend-item"><div class="dot" style="background:#7BC67E"></div> ì£¼ë§ì •ëª¨</div>
    </div>

    <div class="calendar-section">
      <div class="calendar-scroll">
        <div class="calendar-wide">
          <div class="day-headers">
            <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div>
            <div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
          </div>
          <div class="calendar-grid" id="calGrid"></div>
        </div>
      </div>
    </div>

    <div class="info-section" id="infoSection"></div>

    <div class="footer" id="footerSection">
      <strong>SMILE CLIMBING CREW</strong> &nbsp;|&nbsp; ë¬¸ì˜: ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ… &nbsp;|&nbsp; #ìŠ¤ë§ˆì¼í´ë¼ì´ë°
    </div>
  </div>

  <!-- âœ… Identity ìœ„ì ¯ì€ ë”± 1ë²ˆë§Œ ë¡œë“œ -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    /***********************
     * 0) ìš´ì˜ì§„ ì„¤ì •
     ***********************/
    // âœ… ìš´ì˜ì§„ ì´ë©”ì¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (ìš´ì˜ì§„ ì´ë©”ì¼ ë°›ìœ¼ë©´ ì—¬ê¸°ì— ì¶”ê°€)
    const ADMIN_EMAILS = [
      "dlgusqls44@gmail.com",
      // "admin2@example.com",
    ];

    function openIdentity() {
      if (window.netlifyIdentity) window.netlifyIdentity.open();
    }

    function isAdminUser(user) {
      if (!user || !user.email) return false;
      if (ADMIN_EMAILS.length === 0) return true; // (ì›í•˜ë©´ ì „ì²´ ìš´ì˜ì§„ í—ˆìš©)
      return ADMIN_EMAILS.includes(user.email);
    }

    function showAdminUI() {
      const bar = document.getElementById("adminBar");
      if (bar) bar.style.display = "flex";

      // ì„¤ì • íŒ¨ë„/ìƒë‹¨ ë²„íŠ¼ í™œì„±í™”
      const settingsWrap = document.querySelector(".settings-wrap");
      const noticeExit = document.querySelector(".notice-exit");
      const topActions = document.querySelector(".top-actions");

      if (settingsWrap) settingsWrap.style.display = "block";
      if (noticeExit) noticeExit.style.display = "block";
      if (topActions) topActions.style.display = "flex";

      // ê´€ë¦¬ì ë²„íŠ¼ í™œì„±í™”
      const btnPreview = document.getElementById("btnPreview");
      const btnApply = document.getElementById("btnApply");
      if (btnPreview) btnPreview.style.display = "inline-block";
      if (btnApply) btnApply.style.display = "inline-block";

      // ìš´ì˜ì§„ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì • ë³´ì´ê²Œ(ìº¡ì²˜ëª¨ë“œ í•´ì œ)
      document.body.classList.remove('notice-mode');
    }

    function hideAdminUI() {
      const bar = document.getElementById("adminBar");
      if (bar) bar.style.display = "none";
      // ì¼ë°˜ ìœ ì €ëŠ” ìº¡ì²˜ ëª¨ë“œë¡œ ìœ ì§€(ì›í•˜ë©´)
      document.body.classList.add('notice-mode');
    }

    function getIdentityToken() {
      const u = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      return u && u.token ? u.token.access_token : null;
    }

    /***********************
     * 1) UI ë™ì‘ë“¤(ê¸°ì¡´)
     ***********************/
    function toggleSettings() {
      const panel = document.getElementById('settingsPanel');
      const btn   = document.getElementById('toggleBtn');
      panel.classList.toggle('open');
      btn.classList.toggle('open');
    }

    function addSpecial() {
      const list = document.getElementById('specialList');
      const row = document.createElement('div');
      row.className = 'special-row';
      row.innerHTML = `
        <input class="date-input" type="number" placeholder="ë‚ ì§œ" min="1" max="31"
          style="border:1.5px solid #ddd;border-radius:9px;padding:8px 11px;font-size:13px;font-family:inherit;outline:none;background:#fafafa;max-width:80px;"/>
        <input type="text" placeholder="ë‚´ìš© (ì˜ˆ: ë²ˆê°œ, ëŒ€íšŒ ì°¸ê°€)"
          style="border:1.5px solid #ddd;border-radius:9px;padding:8px 11px;font-size:13px;font-family:inherit;outline:none;flex:1;background:#fafafa;"/>
        <input type="text" placeholder="ì¥ì†Œ (ì„ íƒ)"
          style="border:1.5px solid #ddd;border-radius:9px;padding:8px 11px;font-size:13px;font-family:inherit;outline:none;flex:1;background:#fafafa;"/>
        <button class="btn-remove" onclick="removeSpecial(this)">Ã—</button>`;
      list.appendChild(row);
    }

    function removeSpecial(btn) {
      const rows = document.querySelectorAll('.special-row');
      if (rows.length > 1) btn.parentElement.remove();
      else { btn.parentElement.querySelectorAll('input').forEach(i => i.value = ''); }
    }

    function enterNoticeMode() {
      document.body.classList.add('notice-mode');
      window.scrollTo({ top: document.getElementById('calendarCard').offsetTop - 20, behavior: 'smooth' });
    }
    function exitNoticeMode() { document.body.classList.remove('notice-mode'); }

    function parseDates(str) {
      if (!str || !str.trim()) return [];
      return str.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 31);
    }

    /***********************
     * 2) config.json ë¡œë“œ/ì ìš©
     ***********************/
    async function loadConfig() {
      const url = `./config.json?v=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`config.json load failed: ${res.status}`);
      return await res.json();
    }

    function applyConfigToForm(cfg) {
      document.getElementById('inp-year').value  = cfg.year ?? new Date().getFullYear();
      document.getElementById('inp-month').value = cfg.month ?? (new Date().getMonth() + 1);

      const weekend = cfg.weekend ?? {};
      const weekday = cfg.weekday ?? {};

      document.getElementById('inp-weekend-dates').value = Array.isArray(weekend.dates) ? weekend.dates.join(', ') : '';
      document.getElementById('inp-weekend-time').value  = weekend.time ?? '';
      document.getElementById('inp-weekend-place').value = weekend.place ?? '';

      document.getElementById('inp-weekday-dates').value = Array.isArray(weekday.dates) ? weekday.dates.join(', ') : '';
      document.getElementById('inp-weekday-time').value  = weekday.time ?? '';
      document.getElementById('inp-weekday-place').value = weekday.place ?? '';

      document.getElementById('inp-contact').value = cfg.contact ?? 'ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ…';
      document.getElementById('inp-hashtag').value = cfg.hashtag ?? '#ì‹±ê¸€ë²™í´';

      const list = document.getElementById('specialList');
      list.innerHTML = '';
      const specials = Array.isArray(cfg.specials) ? cfg.specials : [];
      if (specials.length === 0) addSpecial();
      specials.forEach(s => {
        addSpecial();
        const rows = document.querySelectorAll('.special-row');
        const row = rows[rows.length - 1];
        const inputs = row.querySelectorAll('input');
        inputs[0].value = s.day ?? '';
        inputs[1].value = s.label ?? '';
        inputs[2].value = s.place ?? '';
      });
    }

    /***********************
     * 3) ë Œë”(ë‹¬ë ¥ ìƒì„±)
     ***********************/
    function generateFromConfig(cfg) {
      const year  = parseInt(cfg.year);
      const month = parseInt(cfg.month);

      const contact = (cfg.contact ?? '').toString().trim();
      const hashtag = (cfg.hashtag ?? '').toString().trim();

      const weekend = cfg.weekend ?? {};
      const weekday = cfg.weekday ?? {};

      const weekendDates = Array.isArray(weekend.dates) ? weekend.dates : [];
      const weekdayDates = Array.isArray(weekday.dates) ? weekday.dates : [];

      const weekendTime  = (weekend.time ?? '').toString().trim();
      const weekendPlace = (weekend.place ?? '').toString().trim();

      const weekdayTime  = (weekday.time ?? '').toString().trim();
      const weekdayPlace = (weekday.place ?? '').toString().trim();

      // specials: { day: [{label, place}] }
      const specials = {};
      const specialList = Array.isArray(cfg.specials) ? cfg.specials : [];
      specialList.forEach(item => {
        const d = parseInt(item.day);
        const label = (item.label ?? '').toString().trim();
        const place = (item.place ?? '').toString().trim();
        if (!isNaN(d) && d >= 1 && d <= 31 && label) {
          if (!specials[d]) specials[d] = [];
          specials[d].push({ label, place });
        }
      });

      document.getElementById('hdr-label').textContent = `${year} Schedule`;
      document.getElementById('hdr-title').innerHTML = `${month}ì›” <span>ì •ëª¨ ì¼ì •</span>`;

      const grid = document.getElementById('calGrid');
      grid.innerHTML = '';
      const today = new Date();
      const firstDay = new Date(year, month - 1, 1).getDay();
      const lastDate = new Date(year, month, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        const e = document.createElement('div');
        e.className = 'cell empty';
        grid.appendChild(e);
      }

      for (let d = 1; d <= lastDate; d++) {
        const dow = (firstDay + d - 1) % 7;
        const cell = document.createElement('div');
        let cls = 'cell';
        if (dow === 0) cls += ' sun';
        if (dow === 6) cls += ' sat';
        const isToday = (today.getFullYear() === year && today.getMonth() === month - 1 && today.getDate() === d);
        if (isToday) cls += ' today';
        cell.className = cls;

        const num = document.createElement('div');
        num.className = 'date-num';
        num.textContent = d;
        cell.appendChild(num);

        if (weekendDates.includes(d)) {
          const b = document.createElement('div');
          b.className = 'badge weekend';
          b.textContent = '';
          cell.appendChild(b);
        }
        if (weekdayDates.includes(d)) {
          const b = document.createElement('div');
          b.className = 'badge weekday';
          b.textContent = '';
          cell.appendChild(b);
        }

        if (specials[d] && specials[d].length > 0) {
          specials[d].forEach(item => {
            const b = document.createElement('div');
            b.className = 'badge special';
            b.textContent = item.label;
            cell.appendChild(b);
          });
        }

        grid.appendChild(cell);
      }

      const info = document.getElementById('infoSection');
      info.innerHTML = '';

      if (weekendDates.length > 0) {
        const dateStr = weekendDates.map(d => `${month}/${d}`).join(', ');
        const timeStr = weekendTime || 'ì¶”í›„ ê³µì§€';
        const placeStr = weekendPlace || 'ì¶”í›„ ê³µì§€ (ì¹´í†¡ë°© í™•ì¸)';
        info.innerHTML += `
          <div class="info-card green">
            <div class="icon">ğŸ§—</div>
            <div class="body">
              <strong>ì£¼ë§ ì •ëª¨ â€” ${dateStr}</strong>
              <span>â° ${timeStr} ì§‘í•© &nbsp;|&nbsp; ğŸ“ ${placeStr}</span>
            </div>
          </div>`;
      }

      if (weekdayDates.length > 0) {
        const dateStr = weekdayDates.map(d => `${month}/${d}`).join(', ');
        const timeStr = weekdayTime || 'ì¶”í›„ ê³µì§€';
        const placeStr = weekdayPlace || 'ì¶”í›„ ê³µì§€ (ì¹´í†¡ë°© í™•ì¸)';
        info.innerHTML += `
          <div class="info-card orange">
            <div class="icon">ğŸ‹ï¸</div>
            <div class="body">
              <strong>í‰ì¼ ì •ëª¨ â€” ${dateStr}</strong>
              <span>â° ${timeStr} ì§‘í•© &nbsp;|&nbsp; ğŸ“ ${placeStr}</span>
            </div>
          </div>`;
      }

      const specialDays = Object.keys(specials).map(k => parseInt(k)).sort((a,b) => a-b);
      if (specialDays.length > 0) {
        const rows = specialDays.map(day => {
          return specials[day].map(v => {
            let line = `<strong>â­ ${month}/${day} â€” ${v.label}</strong>`;
            if (v.place) line += `<span>ğŸ§— ${v.place}</span>`;
            return line;
          }).join('');
        }).join('');

        info.innerHTML += `
          <div class="info-card purple">
            <div class="icon">â­</div>
            <div class="body">${rows}</div>
          </div>`;
      }

      if (weekendDates.length === 0 && weekdayDates.length === 0 && specialDays.length === 0) {
        info.innerHTML = `
          <div class="info-card blue">
            <div class="icon">â„¹ï¸</div>
            <div class="body">
              <strong>ì¼ì • ì•ˆë‚´</strong>
              <span>config.jsonì— ì¼ì •ì„ ì…ë ¥ í›„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</span>
            </div>
          </div>`;
      }

      document.getElementById('footerSection').innerHTML =
        `<strong>SMILE CLIMBING CREW</strong> &nbsp;|&nbsp; ë¬¸ì˜: ${contact || 'ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ…'} &nbsp;|&nbsp; ${hashtag || '#ì‹±ê¸€ë²™í´'}`;
    }

    /***********************
     * 4) í¼ -> config ìƒì„± (ìš´ì˜ì§„ ë¯¸ë¦¬ë³´ê¸°/ì ìš©ìš©)
     ***********************/
    function buildConfigFromForm() {
      const cfg = {
        year: parseInt(document.getElementById('inp-year').value),
        month: parseInt(document.getElementById('inp-month').value),
        contact: document.getElementById('inp-contact').value.trim(),
        hashtag: document.getElementById('inp-hashtag').value.trim(),
        weekend: {
          dates: parseDates(document.getElementById('inp-weekend-dates').value),
          time: document.getElementById('inp-weekend-time').value.trim(),
          place: document.getElementById('inp-weekend-place').value.trim()
        },
        weekday: {
          dates: parseDates(document.getElementById('inp-weekday-dates').value),
          time: document.getElementById('inp-weekday-time').value.trim(),
          place: document.getElementById('inp-weekday-place').value.trim()
        },
        specials: []
      };

      // specials í¼ ìˆ˜ì§‘(ê°™ì€ ë‚ ì§œ ì—¬ëŸ¬ê°œ ê°€ëŠ¥)
      const specialsMap = {};
      document.querySelectorAll('.special-row').forEach(row => {
        const inputs = row.querySelectorAll('input');
        const d = parseInt(inputs[0].value);
        const label = (inputs[1].value || '').trim();
        const place = (inputs[2].value || '').trim();
        if (!isNaN(d) && d >= 1 && d <= 31 && label) {
          if (!specialsMap[d]) specialsMap[d] = [];
          specialsMap[d].push({ day: d, label, place });
        }
      });
      cfg.specials = Object.values(specialsMap).flat();

      return cfg;
    }

    // ì„¤ì •íŒ¨ë„ì˜ "ë‹¬ë ¥ ìƒì„±í•˜ê¸°" ë²„íŠ¼ì€ ë¯¸ë¦¬ë³´ê¸°ë¡œ ìœ ì§€
    function generate() {
      const cfg = buildConfigFromForm();
      generateFromConfig(cfg);
      document.getElementById('calendarCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /***********************
     * 5) ìš´ì˜ì§„ ë²„íŠ¼ ë™ì‘
     ***********************/
    function adminPreview() {
      generate();
    }

    async function adminApply() {
      try {
        const token = getIdentityToken();
        if (!token) throw new Error("ìš´ì˜ì§„ ë¡œê·¸ì¸ í›„ì— ì ìš©í•  ìˆ˜ ìˆì–´ìš”.");

        const config = buildConfigFromForm();

        const res = await fetch("/.netlify/functions/update-config", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            config,
            message: `Update schedule via index.html`
          })
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(`ì»¤ë°‹ ì‹¤íŒ¨: ${res.status} ${t}`);
        }

        alert("ì ìš© ì™„ë£Œ! (GitHubì— ì»¤ë°‹ë¨)\në°°í¬ ë°˜ì˜ê¹Œì§€ ì ì‹œ í›„ ìë™ ë°˜ì˜ë¼ìš”.");
      } catch (e) {
        alert(e.message || String(e));
      }
    }

    /***********************
     * 6) ì´ˆëŒ€ ë§í¬(invite_token) ì²˜ë¦¬
     ***********************/
    function getInviteToken() {
      // 1) ?invite_token=...
      const sp = new URLSearchParams(window.location.search);
      if (sp.has("invite_token")) return sp.get("invite_token");

      // 2) #invite_token=... or #...invite_token=...
      const hash = window.location.hash || "";
      const idx = hash.indexOf("invite_token=");
      if (idx >= 0) {
        return hash.slice(idx).split("invite_token=")[1]?.split("&")[0] || null;
      }
      return null;
    }

    /***********************
     * 7) ì´ˆê¸° ë¡œë“œ: config.json -> í¼/ë Œë”
     ***********************/
    window.addEventListener("load", async () => {
      // (A) ê¸°ë³¸ì€ ì¼ë°˜ ìœ ì € ëª¨ë“œ
      enterNoticeMode();

      // (B) config.json ë¡œë“œí•´ì„œ í™”ë©´ ë Œë”
      try {
        const cfg = await loadConfig();
        applyConfigToForm(cfg);
        generateFromConfig(cfg);
      } catch (e) {
        console.error(e);
        // configê°€ ì—†ìœ¼ë©´ í¼ ê°’ ê¸°ë°˜ìœ¼ë¡œë¼ë„ ë Œë”
        generate();
      }

      // (C) Identity ì´ˆê¸°í™” + ìš´ì˜ì§„ ê²Œì´íŠ¸ + ì´ˆëŒ€ ì²˜ë¦¬
      if (!window.netlifyIdentity) return;
      window.netlifyIdentity.init();

      const inviteToken = getInviteToken();
      if (inviteToken) {
        // ì´ˆëŒ€ í† í°ì´ ìˆìœ¼ë©´ ë¹„ë²ˆ ì„¤ì • ëª¨ë‹¬ ì˜¤í”ˆ
        window.netlifyIdentity.on("init", () => {
          window.netlifyIdentity.open("signup");
        });
      }

      window.netlifyIdentity.on("init", (user) => {
        if (isAdminUser(user)) showAdminUI();
        else hideAdminUI();
      });

      window.netlifyIdentity.on("login", (user) => {
        if (isAdminUser(user)) {
          showAdminUI();
        } else {
          alert("ìš´ì˜ì§„ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
          window.netlifyIdentity.logout();
          hideAdminUI();
        }
      });

      window.netlifyIdentity.on("logout", () => {
        hideAdminUI();
      });
    });
  </script>
</body>
</html>
